<Page
    x:Class="LumaCompanion.WinUI.Views.InteractionView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:LumaCompanion.WinUI.Views"
    xmlns:viewmodels="using:LumaCompanion.WinUI.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{StaticResource LumaDarkGreyBrush}">

    <!-- Set DataContext for the Page if ViewModel is a public property of the Page's code-behind -->
    <!-- This enables {x:Bind ViewModel.Property} directly -->
    <Page.DataContext>
        <viewmodels:InteractionViewModel x:Name="ViewModel"/>
    </Page.DataContext>

    <Grid Margin="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Top bar for buttons -->
            <RowDefinition Height="*"/>    <!-- Main content area -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Top Bar for Buttons -->
        <Grid Grid.Row="0" Padding="10" Background="{StaticResource LumaLightGreyBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Button x:Name="CloseButton" Grid.Column="0" VerticalAlignment="Center"
                    Click="CloseButton_Click" Background="Transparent" BorderThickness="0">
                <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE72B;" Foreground="{StaticResource LumaWhiteBrush}" /> <!-- Back Arrow -->
            </Button>
            <TextBlock Text="Luma Interaction" Grid.Column="1" FontSize="20" FontWeight="SemiBold" 
                       VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{StaticResource LumaWhiteBrush}"/>
            <Button x:Name="SettingsButton" Grid.Column="2" VerticalAlignment="Center"
                    Click="SettingsButton_Click" Background="Transparent" BorderThickness="0">
                <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE713;" Foreground="{StaticResource LumaWhiteBrush}" /> <!-- Settings Icon -->
            </Button>
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/> <!-- Conversation History (approx 75%) -->
                <ColumnDefinition Width="1*"/> <!-- Luma Status & Waveform (approx 25%) -->
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Conversation History -->
            <Border Grid.Column="0" Background="{StaticResource LumaLightGreyBrush}" CornerRadius="8" Margin="0,0,10,0">
                <ListView x:Name="ConversationListView" 
                          ItemsSource="{x:Bind ViewModel.ConversationMessages}"
                          SelectionMode="None"
                          CanReorderItems="False"
                          CanDragItems="False"
                          ShowsScrollingPlaceholders="False"
                          HorizontalContentAlignment="Stretch"
                          Padding="10">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:ChatMessageViewModel">
                            <Grid Margin="5,5" HorizontalAlignment="{x:Bind HorizontalAlignment}">
                                <Border Background="{x:Bind BubbleColor}" 
                                        CornerRadius="10" 
                                        Padding="10,8"
                                        MaxWidth="500">
                                    <TextBlock Text="{x:Bind DisplayMessage}" 
                                               TextWrapping="WrapWholeWords" 
                                               Foreground="{StaticResource LumaWhiteBrush}"
                                               FontSize="15"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,0,0,5"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
            </Border>

            <!-- Right Panel: Luma Status & Waveform -->
            <Grid Grid.Column="1" Margin="10,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>   <!-- Waveform Placeholder -->
                    <RowDefinition Height="*"/>      <!-- Luma Caption -->
                </Grid.RowDefinitions>
                
                <Border x:Name="WaveformPlaceholder" Grid.Row="0" Background="{StaticResource LumaLightGreyBrush}" CornerRadius="8" 
                        MinHeight="150" Margin="0,0,0,10" Tapped="WaveformPlaceholder_Tapped" IsTapEnabled="True">
                    <TextBlock Text="Tap Luma to Speak" 
                               VerticalAlignment="Center" HorizontalAlignment="Center"
                               Foreground="{StaticResource LumaWhiteBrush}" FontSize="16" FontWeight="SemiBold"/>
                </Border>

                <Border Grid.Row="1" Background="{StaticResource LumaLightGreyBrush}" CornerRadius="8">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <TextBlock x:Name="LumaCaptionTextBlock" 
                                   Text="{x:Bind ViewModel.LumaCaptionText, Mode=OneWay}" 
                                   TextWrapping="Wrap"
                                   FontSize="28" 
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource LumaOrangeBrush}"
                                   Padding="15"
                                   VerticalAlignment="Center" HorizontalAlignment="Center" TextAlignment="Center"/>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Grid>
        
        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{StaticResource LumaLightGreyBrush}" Padding="10,5">
            <TextBlock x:Name="StatusTextBlock" Text="{x:Bind ViewModel.StatusText, Mode=OneWay}" 
                       Foreground="{StaticResource LumaWhiteBrush}" FontSize="12" VerticalAlignment="Center"/>
        </Border>
    </Grid>
</Page>
